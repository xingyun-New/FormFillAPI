# FormFillAPI äº‘æœåŠ¡å™¨éƒ¨ç½²æŒ‡å—

## æ¦‚è¿°

è¿™ä»½æŒ‡å—å°†å¸®åŠ©æ‚¨å°†FormFillAPIé¡¹ç›®å®Œæ•´éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨ä¸Šï¼ŒåŒ…æ‹¬ç¯å¢ƒé…ç½®ã€è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ã€è¿›ç¨‹ç®¡ç†ã€åå‘ä»£ç†ã€ç›‘æ§å’Œå®‰å…¨é…ç½®ã€‚

## ç›®å½•
1. [ç¯å¢ƒå‡†å¤‡](#ç¯å¢ƒå‡†å¤‡)
2. [æ–‡ä»¶ä¼ è¾“](#æ–‡ä»¶ä¼ è¾“) 
3. [ç¯å¢ƒé…ç½®](#ç¯å¢ƒé…ç½®)
4. [éƒ¨ç½²è„šæœ¬](#éƒ¨ç½²è„šæœ¬)
5. [è¿›ç¨‹ç®¡ç†](#è¿›ç¨‹ç®¡ç†)
6. [åå‘ä»£ç†](#åå‘ä»£ç†)
7. [ç›‘æ§é…ç½®](#ç›‘æ§é…ç½®)
8. [å®‰å…¨é…ç½®](#å®‰å…¨é…ç½®)
9. [ç»´æŠ¤æ“ä½œ](#ç»´æŠ¤æ“ä½œ)

## ç¯å¢ƒå‡†å¤‡

### æœåŠ¡å™¨è¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 20.04+ / CentOS 7+ 
- **å†…å­˜**: æœ€å°‘2GBï¼Œæ¨è4GB+
- **å­˜å‚¨**: æœ€å°‘10GBå¯ç”¨ç©ºé—´
- **ç½‘ç»œ**: å…·å¤‡å…¬ç½‘IPå’ŒåŸŸåï¼ˆå¯é€‰ï¼‰

### 1. æ›´æ–°ç³»ç»Ÿ
```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

### 2. å®‰è£…Java 17
```bash
# Ubuntu/Debian
sudo apt install openjdk-17-jdk -y

# CentOS/RHEL
sudo yum install java-17-openjdk java-17-openjdk-devel -y

# éªŒè¯å®‰è£…
java -version
javac -version
```

### 3. å®‰è£…Maven
```bash
# Ubuntu/Debian
sudo apt install maven -y

# CentOS/RHEL
sudo yum install maven -y

# éªŒè¯å®‰è£…
mvn -version
```

### 4. å®‰è£…Nginx (å¯é€‰ï¼Œç”¨äºåå‘ä»£ç†)
```bash
# Ubuntu/Debian
sudo apt install nginx -y

# CentOS/RHEL
sudo yum install nginx -y

# å¯åŠ¨å’Œè®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl start nginx
sudo systemctl enable nginx
```

## æ–‡ä»¶ä¼ è¾“

### æ–¹å¼1: ä½¿ç”¨Git (æ¨è)
```bash
# å®‰è£…Git
sudo apt install git -y  # Ubuntu
sudo yum install git -y  # CentOS

# å…‹éš†é¡¹ç›®
cd /opt
sudo git clone https://github.com/your-username/FormFillAPI.git
sudo chown -R $USER:$USER FormFillAPI
cd FormFillAPI
```

### æ–¹å¼2: ä½¿ç”¨SCPä¼ è¾“
```bash
# åœ¨æœ¬åœ°æ‰“åŒ…é¡¹ç›®
tar -czf formfillapi.tar.gz .

# ä¼ è¾“åˆ°æœåŠ¡å™¨
scp formfillapi.tar.gz user@your-server:/opt/

# åœ¨æœåŠ¡å™¨è§£å‹
cd /opt
tar -xzf formfillapi.tar.gz
mv FormFillAPI formfillapi
```

### æ–¹å¼3: ä½¿ç”¨rsyncåŒæ­¥
```bash
# åŒæ­¥é¡¹ç›®æ–‡ä»¶ï¼ˆåœ¨æœ¬åœ°æ‰§è¡Œï¼‰
rsync -avz --exclude 'target/' --exclude '.git/' \
  ./ user@your-server:/opt/formfillapi/
```

## ç¯å¢ƒé…ç½®

### 1. åˆ›å»ºåº”ç”¨ç”¨æˆ·
```bash
# åˆ›å»ºä¸“ç”¨ç”¨æˆ·
sudo useradd -m -s /bin/bash formfill
sudo usermod -aG sudo formfill

# åˆ‡æ¢åˆ°åº”ç”¨ç”¨æˆ·
sudo su - formfill
```

### 2. åˆ›å»ºåº”ç”¨ç›®å½•ç»“æ„
```bash
cd /opt/formfillapi

# ç¡®ä¿ç›®å½•æƒé™æ­£ç¡®
sudo chown -R formfill:formfill /opt/formfillapi
chmod 755 /opt/formfillapi

# åˆ›å»ºå¿…è¦ç›®å½•
mkdir -p templates output logs backups
chmod 755 templates output logs backups
```

### 3. é…ç½®ç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶
```bash
# åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®
cat > src/main/resources/application-prod.yml << 'EOF'
server:
  port: 8080
  servlet:
    context-path: /
    encoding:
      charset: UTF-8
      enabled: true
      force: true

spring:
  application:
    name: FormFillAPI
  
  servlet:
    multipart:
      max-file-size: 100MB
      max-request-size: 100MB
  
  jackson:
    default-property-inclusion: non_null

logging:
  level:
    com.formfill.api: INFO
    org.apache.poi: WARN
    org.springframework: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: /opt/formfillapi/logs/formfill-api.log
    max-size: 100MB
    max-history: 30

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: always
EOF
```

## éƒ¨ç½²è„šæœ¬

### 1. åˆ›å»ºæ„å»ºè„šæœ¬
```bash
cat > scripts/build.sh << 'EOF'
#!/bin/bash

set -e

echo "å¼€å§‹æ„å»ºFormFillAPI..."

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/formfillapi

# å¤‡ä»½æ—§ç‰ˆæœ¬
if [ -f target/form-fill-api-1.0.0.jar ]; then
    cp target/form-fill-api-1.0.0.jar backups/form-fill-api-$(date +%Y%m%d_%H%M%S).jar
    echo "å·²å¤‡ä»½æ—§ç‰ˆæœ¬"
fi

# æ¸…ç†å¹¶ç¼–è¯‘
echo "æ¸…ç†é¡¹ç›®..."
mvn clean

echo "ç¼–è¯‘é¡¹ç›®..."
mvn compile

echo "è¿è¡Œæµ‹è¯•..."
mvn test

echo "æ‰“åŒ…é¡¹ç›®..."
mvn package -DskipTests

# éªŒè¯jaråŒ…
if [ -f target/form-fill-api-1.0.0.jar ]; then
    echo "âœ… æ„å»ºæˆåŠŸ: target/form-fill-api-1.0.0.jar"
    ls -lh target/form-fill-api-1.0.0.jar
else
    echo "âŒ æ„å»ºå¤±è´¥: æœªæ‰¾åˆ°jaråŒ…"
    exit 1
fi

echo "æ„å»ºå®Œæˆ!"
EOF

chmod +x scripts/build.sh
```

### 2. åˆ›å»ºå¯åŠ¨è„šæœ¬
```bash
mkdir -p scripts

cat > scripts/start.sh << 'EOF'
#!/bin/bash

set -e

APP_NAME="FormFillAPI"
APP_JAR="/opt/formfillapi/target/form-fill-api-1.0.0.jar"
PID_FILE="/opt/formfillapi/logs/application.pid"
LOG_FILE="/opt/formfillapi/logs/formfill-api.log"

# JVMå‚æ•°
JVM_OPTS="-Xms1g -Xmx2g -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
JVM_OPTS="$JVM_OPTS -XX:+HeapDumpOnOutOfMemoryError"
JVM_OPTS="$JVM_OPTS -XX:HeapDumpPath=/opt/formfillapi/logs/"

# Springå‚æ•°  
SPRING_OPTS="--spring.profiles.active=prod"
SPRING_OPTS="$SPRING_OPTS --server.port=8080"

echo "å¯åŠ¨ $APP_NAME..."

# æ£€æŸ¥jaråŒ…æ˜¯å¦å­˜åœ¨
if [ ! -f "$APP_JAR" ]; then
    echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ°åº”ç”¨jaråŒ…: $APP_JAR"
    echo "è¯·å…ˆè¿è¡Œæ„å»ºè„šæœ¬: ./scripts/build.sh"
    exit 1
fi

# æ£€æŸ¥æ˜¯å¦å·²ç»è¿è¡Œ
if [ -f "$PID_FILE" ]; then
    OLD_PID=$(cat "$PID_FILE")
    if ps -p $OLD_PID > /dev/null 2>&1; then
        echo "âŒ åº”ç”¨å·²åœ¨è¿è¡Œä¸­ (PID: $OLD_PID)"
        echo "å¦‚éœ€é‡å¯ï¼Œè¯·å…ˆæ‰§è¡Œ: ./scripts/stop.sh"
        exit 1
    else
        echo "æ¸…ç†æ—§çš„PIDæ–‡ä»¶..."
        rm -f "$PID_FILE"
    fi
fi

# ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
mkdir -p $(dirname "$LOG_FILE")

# å¯åŠ¨åº”ç”¨
echo "æ­£åœ¨å¯åŠ¨åº”ç”¨..."
nohup java $JVM_OPTS -jar "$APP_JAR" $SPRING_OPTS > "$LOG_FILE" 2>&1 &
APP_PID=$!

# ä¿å­˜PID
echo $APP_PID > "$PID_FILE"

echo "âœ… åº”ç”¨å¯åŠ¨æˆåŠŸ!"
echo "   PID: $APP_PID"
echo "   æ—¥å¿—: $LOG_FILE"
echo "   URL: http://localhost:8080"

# ç­‰å¾…åº”ç”¨å¯åŠ¨
echo "ç­‰å¾…åº”ç”¨å®Œå…¨å¯åŠ¨..."
sleep 5

# æ£€æŸ¥åº”ç”¨çŠ¶æ€
if ps -p $APP_PID > /dev/null 2>&1; then
    echo "âœ… åº”ç”¨æ­£å¸¸è¿è¡Œ"
    # å¥åº·æ£€æŸ¥
    echo "è¿›è¡Œå¥åº·æ£€æŸ¥..."
    sleep 10
    if curl -f http://localhost:8080/api/health > /dev/null 2>&1; then
        echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
    else
        echo "âš ï¸  å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—"
    fi
else
    echo "âŒ åº”ç”¨å¯åŠ¨å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—: $LOG_FILE"
    rm -f "$PID_FILE"
    exit 1
fi

echo "ğŸ‰ $APP_NAME å¯åŠ¨å®Œæˆ!"
EOF

chmod +x scripts/start.sh
```

### 3. åˆ›å»ºåœæ­¢è„šæœ¬
```bash
cat > scripts/stop.sh << 'EOF'
#!/bin/bash

APP_NAME="FormFillAPI"
PID_FILE="/opt/formfillapi/logs/application.pid"

echo "åœæ­¢ $APP_NAME..."

if [ ! -f "$PID_FILE" ]; then
    echo "âŒ PIDæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåº”ç”¨å¯èƒ½æœªè¿è¡Œ"
    exit 1
fi

PID=$(cat "$PID_FILE")

if ! ps -p $PID > /dev/null 2>&1; then
    echo "âŒ è¿›ç¨‹ä¸å­˜åœ¨ (PID: $PID)"
    rm -f "$PID_FILE"
    exit 1
fi

echo "æ­£åœ¨åœæ­¢è¿›ç¨‹ (PID: $PID)..."

# æ¸©å’Œåœæ­¢
kill $PID

# ç­‰å¾…è¿›ç¨‹ç»“æŸ
for i in {1..30}; do
    if ! ps -p $PID > /dev/null 2>&1; then
        echo "âœ… åº”ç”¨å·²æˆåŠŸåœæ­¢"
        rm -f "$PID_FILE"
        exit 0
    fi
    echo "ç­‰å¾…è¿›ç¨‹ç»“æŸ... ($i/30)"
    sleep 1
done

# å¼ºåˆ¶åœæ­¢
echo "âš ï¸  æ¸©å’Œåœæ­¢è¶…æ—¶ï¼Œå¼ºåˆ¶åœæ­¢..."
kill -9 $PID

if ! ps -p $PID > /dev/null 2>&1; then
    echo "âœ… åº”ç”¨å·²å¼ºåˆ¶åœæ­¢"
    rm -f "$PID_FILE"
else
    echo "âŒ æ— æ³•åœæ­¢åº”ç”¨"
    exit 1
fi
EOF

chmod +x scripts/stop.sh
```

### 4. åˆ›å»ºé‡å¯è„šæœ¬
```bash
cat > scripts/restart.sh << 'EOF'
#!/bin/bash

echo "é‡å¯ FormFillAPI..."

# åœæ­¢åº”ç”¨
./scripts/stop.sh

# ç­‰å¾…ä¸€æ®µæ—¶é—´
sleep 3

# å¯åŠ¨åº”ç”¨
./scripts/start.sh

echo "ğŸ‰ é‡å¯å®Œæˆ!"
EOF

chmod +x scripts/restart.sh
```

### 5. åˆ›å»ºçŠ¶æ€æ£€æŸ¥è„šæœ¬
```bash
cat > scripts/status.sh << 'EOF'
#!/bin/bash

APP_NAME="FormFillAPI"
PID_FILE="/opt/formfillapi/logs/application.pid"

echo "æ£€æŸ¥ $APP_NAME çŠ¶æ€..."

if [ ! -f "$PID_FILE" ]; then
    echo "âŒ çŠ¶æ€: æœªè¿è¡Œ (PIDæ–‡ä»¶ä¸å­˜åœ¨)"
    exit 1
fi

PID=$(cat "$PID_FILE")

if ps -p $PID > /dev/null 2>&1; then
    echo "âœ… çŠ¶æ€: è¿è¡Œä¸­"
    echo "   PID: $PID"
    echo "   å†…å­˜ä½¿ç”¨: $(ps -p $PID -o pid,ppid,pcpu,pmem,comm --no-headers)"
    
    # å¥åº·æ£€æŸ¥
    echo ""
    echo "è¿›è¡Œå¥åº·æ£€æŸ¥..."
    if curl -f -s http://localhost:8080/api/health | jq . 2>/dev/null; then
        echo "âœ… å¥åº·æ£€æŸ¥: é€šè¿‡"
    else
        echo "âš ï¸  å¥åº·æ£€æŸ¥: å¤±è´¥"
    fi
    
    # æ˜¾ç¤ºæœ€è¿‘æ—¥å¿—
    echo ""
    echo "æœ€è¿‘æ—¥å¿— (æœ€å10è¡Œ):"
    echo "----------------------------------------"
    tail -10 /opt/formfillapi/logs/formfill-api.log
    
else
    echo "âŒ çŠ¶æ€: å·²åœæ­¢ (è¿›ç¨‹ä¸å­˜åœ¨)"
    rm -f "$PID_FILE"
    exit 1
fi
EOF

chmod +x scripts/status.sh
```

## è¿›ç¨‹ç®¡ç†

### ä½¿ç”¨Systemdç®¡ç†æœåŠ¡

```bash
# åˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶
sudo cat > /etc/systemd/system/formfillapi.service << 'EOF'
[Unit]
Description=FormFillAPI Service
After=network.target

[Service]
Type=forking
User=formfill
Group=formfill
WorkingDirectory=/opt/formfillapi

# ç¯å¢ƒå˜é‡
Environment="JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64"
Environment="SPRING_PROFILES_ACTIVE=prod"

# å¯åŠ¨å‘½ä»¤
ExecStart=/opt/formfillapi/scripts/start.sh
ExecStop=/opt/formfillapi/scripts/stop.sh
ExecReload=/opt/formfillapi/scripts/restart.sh

# è¿›ç¨‹ç®¡ç†
PIDFile=/opt/formfillapi/logs/application.pid
Restart=always
RestartSec=10

# æ—¥å¿—
StandardOutput=append:/opt/formfillapi/logs/systemd.log
StandardError=append:/opt/formfillapi/logs/systemd-error.log

[Install]
WantedBy=multi-user.target
EOF

# é‡æ–°åŠ è½½systemdé…ç½®
sudo systemctl daemon-reload

# å¯ç”¨æœåŠ¡
sudo systemctl enable formfillapi

# å¯åŠ¨æœåŠ¡
sudo systemctl start formfillapi

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status formfillapi
```

### Systemdå¸¸ç”¨å‘½ä»¤
```bash
# å¯åŠ¨æœåŠ¡
sudo systemctl start formfillapi

# åœæ­¢æœåŠ¡
sudo systemctl stop formfillapi

# é‡å¯æœåŠ¡
sudo systemctl restart formfillapi

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status formfillapi

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u formfillapi -f

# è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl enable formfillapi

# å–æ¶ˆå¼€æœºè‡ªå¯
sudo systemctl disable formfillapi
```

## åå‘ä»£ç†

### Nginxé…ç½®

```bash
# åˆ›å»ºNginxé…ç½®æ–‡ä»¶
sudo cat > /etc/nginx/sites-available/formfillapi << 'EOF'
server {
    listen 80;
    server_name your-domain.com;  # æ›¿æ¢ä¸ºæ‚¨çš„åŸŸå
    
    # ä¸Šä¼ å¤§å°é™åˆ¶
    client_max_body_size 100M;
    
    # æ—¥å¿—é…ç½®
    access_log /var/log/nginx/formfillapi_access.log;
    error_log /var/log/nginx/formfillapi_error.log;
    
    # åå‘ä»£ç†åˆ°Spring Bootåº”ç”¨
    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # ç¼“å†²è®¾ç½®
        proxy_buffering on;
        proxy_buffer_size 8k;
        proxy_buffers 8 8k;
    }
    
    # é™æ€æ–‡ä»¶ä»£ç† (å¦‚æœéœ€è¦)
    location /static/ {
        alias /opt/formfillapi/static/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # å¥åº·æ£€æŸ¥ç«¯ç‚¹
    location /health {
        proxy_pass http://127.0.0.1:8080/api/health;
        access_log off;
    }
}
EOF

# å¯ç”¨ç«™ç‚¹
sudo ln -s /etc/nginx/sites-available/formfillapi /etc/nginx/sites-enabled/

# æµ‹è¯•Nginxé…ç½®
sudo nginx -t

# é‡æ–°åŠ è½½Nginx
sudo systemctl reload nginx
```

### SSLé…ç½® (ä½¿ç”¨Let's Encrypt)

```bash
# å®‰è£…Certbot
sudo apt install certbot python3-certbot-nginx -y

# è·å–SSLè¯ä¹¦
sudo certbot --nginx -d your-domain.com

# è‡ªåŠ¨ç»­æœŸ
sudo crontab -e
# æ·»åŠ ä»¥ä¸‹è¡Œ:
# 0 12 * * * /usr/bin/certbot renew --quiet
```

## ç›‘æ§é…ç½®

### 1. åˆ›å»ºç›‘æ§è„šæœ¬

```bash
cat > scripts/monitor.sh << 'EOF'
#!/bin/bash

ALERT_EMAIL="admin@your-domain.com"  # æ›¿æ¢ä¸ºæ‚¨çš„é‚®ç®±
LOG_FILE="/opt/formfillapi/logs/monitor.log"

# è®°å½•ç›‘æ§æ—¥å¿—
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# æ£€æŸ¥åº”ç”¨çŠ¶æ€
check_application() {
    if ! curl -f -s http://localhost:8080/api/health > /dev/null; then
        log_message "ERROR: åº”ç”¨å¥åº·æ£€æŸ¥å¤±è´¥"
        return 1
    fi
    return 0
}

# æ£€æŸ¥ç£ç›˜ç©ºé—´
check_disk_space() {
    USAGE=$(df /opt/formfillapi | awk 'NR==2 {print $5}' | sed 's/%//')
    if [ "$USAGE" -gt 85 ]; then
        log_message "WARNING: ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜: ${USAGE}%"
        return 1
    fi
    return 0
}

# æ£€æŸ¥å†…å­˜ä½¿ç”¨
check_memory() {
    PID_FILE="/opt/formfillapi/logs/application.pid"
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        MEM_USAGE=$(ps -p $PID -o pmem --no-headers | tr -d ' ')
        if (( $(echo "$MEM_USAGE > 80" | bc -l) )); then
            log_message "WARNING: å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: ${MEM_USAGE}%"
            return 1
        fi
    fi
    return 0
}

# ä¸»ç›‘æ§é€»è¾‘
main() {
    log_message "å¼€å§‹ç›‘æ§æ£€æŸ¥"
    
    ERROR_COUNT=0
    
    if ! check_application; then
        ERROR_COUNT=$((ERROR_COUNT + 1))
    fi
    
    if ! check_disk_space; then
        ERROR_COUNT=$((ERROR_COUNT + 1))
    fi
    
    if ! check_memory; then
        ERROR_COUNT=$((ERROR_COUNT + 1))
    fi
    
    if [ $ERROR_COUNT -gt 0 ]; then
        log_message "å‘ç° $ERROR_COUNT ä¸ªé—®é¢˜"
        # è¿™é‡Œå¯ä»¥æ·»åŠ é‚®ä»¶é€šçŸ¥é€»è¾‘
    else
        log_message "æ‰€æœ‰æ£€æŸ¥é€šè¿‡"
    fi
}

main "$@"
EOF

chmod +x scripts/monitor.sh
```

### 2. è®¾ç½®å®šæ—¶ç›‘æ§

```bash
# æ·»åŠ åˆ°crontab
crontab -e

# æ·»åŠ ä»¥ä¸‹è¡Œ (æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡)
*/5 * * * * /opt/formfillapi/scripts/monitor.sh

# æ¯å¤©å‡Œæ™¨æ¸…ç†æ—¥å¿—
0 0 * * * find /opt/formfillapi/logs -name "*.log" -mtime +30 -delete
```

### 3. æ—¥å¿—è½®è½¬é…ç½®

```bash
sudo cat > /etc/logrotate.d/formfillapi << 'EOF'
/opt/formfillapi/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 formfill formfill
    postrotate
        # é‡å¯åº”ç”¨ä»¥é‡æ–°æ‰“å¼€æ—¥å¿—æ–‡ä»¶
        systemctl reload formfillapi
    endscript
}
EOF
```

## å®‰å…¨é…ç½®

### 1. é˜²ç«å¢™é…ç½®

```bash
# Ubuntu (UFW)
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw --force enable

# CentOS (firewalld)
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

### 2. ç”¨æˆ·æƒé™é…ç½®

```bash
# è®¾ç½®æ–‡ä»¶æƒé™
sudo chown -R formfill:formfill /opt/formfillapi
sudo chmod 750 /opt/formfillapi
sudo chmod 755 /opt/formfillapi/scripts/*.sh
sudo chmod 644 /opt/formfillapi/logs/*.log
```

### 3. åº”ç”¨å®‰å…¨é…ç½®

åœ¨`application-prod.yml`ä¸­æ·»åŠ å®‰å…¨é…ç½®ï¼š

```yaml
# å®‰å…¨é…ç½®
server:
  servlet:
    session:
      timeout: 30m
  error:
    include-stacktrace: never
    include-message: never

spring:
  security:
    headers:
      frame-options: DENY
      content-type-options: nosniff
      xss-protection: 1; mode=block
```

## ç»´æŠ¤æ“ä½œ

### 1. éƒ¨ç½²æ–°ç‰ˆæœ¬

```bash
cat > scripts/deploy.sh << 'EOF'
#!/bin/bash

set -e

echo "å¼€å§‹éƒ¨ç½²æ–°ç‰ˆæœ¬..."

# 1. å¤‡ä»½å½“å‰ç‰ˆæœ¬
./scripts/stop.sh
cp -r /opt/formfillapi /opt/formfillapi_backup_$(date +%Y%m%d_%H%M%S)

# 2. æ›´æ–°ä»£ç  (å¦‚æœä½¿ç”¨Git)
git pull origin main

# 3. æ„å»ºæ–°ç‰ˆæœ¬
./scripts/build.sh

# 4. å¯åŠ¨åº”ç”¨
./scripts/start.sh

# 5. å¥åº·æ£€æŸ¥
sleep 15
if curl -f http://localhost:8080/api/health > /dev/null 2>&1; then
    echo "âœ… éƒ¨ç½²æˆåŠŸ"
else
    echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œå›æ»šåˆ°å¤‡ä»½ç‰ˆæœ¬"
    # è¿™é‡Œå¯ä»¥æ·»åŠ å›æ»šé€»è¾‘
    exit 1
fi

echo "ğŸ‰ éƒ¨ç½²å®Œæˆ!"
EOF

chmod +x scripts/deploy.sh
```

### 2. æ•°æ®å¤‡ä»½è„šæœ¬

```bash
cat > scripts/backup.sh << 'EOF'
#!/bin/bash

BACKUP_DIR="/opt/backups/formfillapi"
DATE=$(date +%Y%m%d_%H%M%S)

echo "å¼€å§‹å¤‡ä»½..."

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p "$BACKUP_DIR"

# å¤‡ä»½æ¨¡æ¿æ–‡ä»¶
tar -czf "$BACKUP_DIR/templates_$DATE.tar.gz" -C /opt/formfillapi templates/

# å¤‡ä»½è¾“å‡ºæ–‡ä»¶ (æœ€è¿‘7å¤©çš„)
find /opt/formfillapi/output -name "*.xlsx" -mtime -7 | \
    tar -czf "$BACKUP_DIR/output_$DATE.tar.gz" -T -

# å¤‡ä»½æ—¥å¿—æ–‡ä»¶
tar -czf "$BACKUP_DIR/logs_$DATE.tar.gz" -C /opt/formfillapi logs/

# æ¸…ç†æ—§å¤‡ä»½ (ä¿ç•™30å¤©)
find "$BACKUP_DIR" -name "*.tar.gz" -mtime +30 -delete

echo "âœ… å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
EOF

chmod +x scripts/backup.sh
```

### 3. æ€§èƒ½è°ƒä¼˜

```bash
# åœ¨scripts/start.shä¸­è°ƒæ•´JVMå‚æ•°
JVM_OPTS="-Xms2g -Xmx4g"
JVM_OPTS="$JVM_OPTS -XX:+UseG1GC"
JVM_OPTS="$JVM_OPTS -XX:MaxGCPauseMillis=200"
JVM_OPTS="$JVM_OPTS -XX:+UnlockExperimentalVMOptions"
JVM_OPTS="$JVM_OPTS -XX:+UseStringDeduplication"
JVM_OPTS="$JVM_OPTS -XX:+HeapDumpOnOutOfMemoryError"
JVM_OPTS="$JVM_OPTS -XX:HeapDumpPath=/opt/formfillapi/logs/"
```

## å®Œæ•´éƒ¨ç½²æµç¨‹

### ä¸€é”®éƒ¨ç½²è„šæœ¬

```bash
cat > deploy-all.sh << 'EOF'
#!/bin/bash

set -e

echo "ğŸš€ å¼€å§‹ä¸€é”®éƒ¨ç½² FormFillAPI..."

# 1. æ£€æŸ¥ç¯å¢ƒ
echo "ğŸ“‹ æ£€æŸ¥ç¯å¢ƒ..."
./scripts/check-env.sh

# 2. æ„å»ºåº”ç”¨
echo "ğŸ”¨ æ„å»ºåº”ç”¨..."
./scripts/build.sh

# 3. é…ç½®ç³»ç»ŸæœåŠ¡
echo "âš™ï¸  é…ç½®ç³»ç»ŸæœåŠ¡..."
sudo systemctl enable formfillapi

# 4. å¯åŠ¨åº”ç”¨
echo "ğŸ¬ å¯åŠ¨åº”ç”¨..."
sudo systemctl start formfillapi

# 5. é…ç½®Nginx
echo "ğŸŒ é…ç½®Nginx..."
sudo systemctl reload nginx

# 6. éªŒè¯éƒ¨ç½²
echo "âœ… éªŒè¯éƒ¨ç½²..."
sleep 15
if curl -f http://localhost:8080/api/health > /dev/null 2>&1; then
    echo "ğŸ‰ éƒ¨ç½²æˆåŠŸ!"
    echo "åº”ç”¨å·²è¿è¡Œåœ¨: http://your-domain.com"
else
    echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
    exit 1
fi

echo ""
echo "ğŸ“š å¸¸ç”¨å‘½ä»¤:"
echo "  æŸ¥çœ‹çŠ¶æ€: sudo systemctl status formfillapi"
echo "  æŸ¥çœ‹æ—¥å¿—: tail -f /opt/formfillapi/logs/formfill-api.log"
echo "  é‡å¯åº”ç”¨: sudo systemctl restart formfillapi"
echo ""
EOF

chmod +x deploy-all.sh
```

## æ€»ç»“

å®Œæˆä»¥ä¸Šé…ç½®åï¼Œæ‚¨çš„FormFillAPIå°±å¯ä»¥åœ¨äº‘æœåŠ¡å™¨ä¸Šç¨³å®šè¿è¡Œäº†ã€‚ä¸»è¦ç‰¹ç‚¹ï¼š

- âœ… **è‡ªåŠ¨åŒ–éƒ¨ç½²**: ä¸€é”®éƒ¨ç½²è„šæœ¬
- âœ… **è¿›ç¨‹ç®¡ç†**: SystemdæœåŠ¡ç®¡ç†
- âœ… **åå‘ä»£ç†**: Nginxè´Ÿè½½å‡è¡¡å’ŒSSL
- âœ… **ç›‘æ§å‘Šè­¦**: è‡ªåŠ¨å¥åº·æ£€æŸ¥
- âœ… **æ—¥å¿—ç®¡ç†**: è‡ªåŠ¨è½®è½¬å’Œæ¸…ç†
- âœ… **å®‰å…¨é˜²æŠ¤**: é˜²ç«å¢™å’Œæƒé™æ§åˆ¶
- âœ… **å¤‡ä»½æ¢å¤**: è‡ªåŠ¨å¤‡ä»½ç­–ç•¥

å¦‚æœæ‚¨åœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ç›¸åº”çš„æ—¥å¿—æ–‡ä»¶æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚ 